<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #333; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Main application wrapper to handle layout */
        #app-wrapper {
            display: flex;
            width: 100%;
            max-width: 1200px; 
            min-height: 90vh; 
            border-radius: 1rem;
            overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            margin: auto;
        }

        /* Sidebar styling */
        #sidebar {
            width: 250px; 
            background-color: #4a148c; 
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            display: none; 
        }

        /* When sidebar should be visible, apply flex */
        #sidebar.visible {
            display: flex;
        }


        .sidebar-nav-item {
            width: 100%;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            background-color: #6a1b9a; 
            color: white;
            font-weight: 600;
            text-align: left;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }

        .sidebar-nav-item:hover {
            background-color: #7b29b0;
        }
        /* Active state for sidebar items */
        .sidebar-nav-item.active-sidebar-item {
            background-color: #7b29b0; 
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5); 
        }

        #logout-sidebar-button {
            background-color: #dc2626; 
            margin-top: auto; 
        }

        #logout-sidebar-button:hover {
            background-color: #ef4444;
        }

        /* Main content area */
        #main-content {
            flex-grow: 1; 
            background-color: #2b2b2b; 
            padding: 2rem;
            display: flex;
            justify-content: center; 
            align-items: center; 
            overflow-y: auto;
        }

        /* Expense tracker card (now inside main-content) */
        .expense-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            width: 100%;
            max-width: 28rem; 
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        input, button, select {
            border-radius: 0.5rem;
        }
        .message-box {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Specific styles for the login/signup buttons to match the new scheme */
        #show-login, #show-signup {
            transition: all 0.2s ease-in-out;
        }
        #show-login.active, #show-signup.active {
            background-color: #4a148c; 
            color: white;
        }
        #show-login:not(.active), #show-signup:not(.active) {
            background-color: #e0e7ff; 
            color: #4a148c; 
        }

        /* Responsive adjustments for dashboard */
        @media (max-width: 768px) {
            #app-wrapper {
                flex-direction: column;
                min-height: 100vh;
                border-radius: 0; 
            }
            #sidebar {
                width: 100%; 
                padding: 1rem;
                flex-direction: row; 
                flex-wrap: wrap; 
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }
            .sidebar-nav-item {
                margin: 0.5rem;
                padding: 0.75rem 1rem;
                flex-grow: 1; 
                text-align: center;
            }
            #logout-sidebar-button {
                margin-top: 0;
            }
            #main-content {
                padding: 1rem;
                align-items: center; 
            }
            .expense-card {
                max-width: 100%;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <nav id="sidebar">
            <div>
                <button id="profile-sidebar-btn" class="sidebar-nav-item">Profile</button>
                <button id="expenses-sidebar-btn" class="sidebar-nav-item">Expenses</button>
                <button id="investments-sidebar-btn" class="sidebar-nav-item">Investments</button>
                <button id="about-sidebar-btn" class="sidebar-nav-item">About</button>
                <button id="messages-sidebar-btn" class="sidebar-nav-item">Messages</button>
            </div>
            <button id="logout-sidebar-button" class="sidebar-nav-item">LOG OUT</button>
        </nav>

        <div id="main-content">
            <div id="auth-section" class="expense-card">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Welcome to Expense Tracker</h2>

                <div class="flex justify-center mb-4">
                    <button id="show-login" class="px-6 py-2 rounded-l-lg font-medium active">Login</button>
                    <button id="show-signup" class="px-6 py-2 rounded-r-lg font-medium">Sign Up</button>
                </div>

                <form id="login-form" class="flex flex-col gap-4">
                    <input type="email" id="login-email" placeholder="Email" class="p-3 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <input type="password" id="login-password" placeholder="Password" class="p-3 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <button type="submit" class="p-3 bg-indigo-600 text-white font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">Login</button>
                </form>

                <form id="signup-form" class="hidden flex flex-col gap-4">
                    <input type="email" id="signup-email" placeholder="Email" class="p-3 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <input type="password" id="signup-password" placeholder="Password" class="p-3 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm Password" class="p-3 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <button type="submit" class="p-3 bg-indigo-600 text-white font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">Sign Up</button>
                </form>

                <div id="auth-message" class="message-box hidden"></div>
            </div>

            <div id="expense-tracker-section" class="expense-card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">My Expenses</h2>
                </div>

                <form id="add-expense-form" class="flex flex-col gap-3 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Add New Expense</h3>
                    <input type="text" id="expense-description" placeholder="Description" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    
                    <select id="expense-category" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                        <option value="">Select Category</option>
                        <option value="Food">Food</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Housing">Housing</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Education">Education</option>
                        <option value="Other">Other</option>
                    </select>

                    <input type="number" id="expense-amount" placeholder="Amount" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" step="0.01" required>
                    
                    <input type="date" id="expense-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>

                    <button type="submit" class="p-2 bg-indigo-600 text-white font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">Add Expense</button>
                </form>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Expense List</h3>
                    <div id="expenses-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4" id="no-expenses-message">No expenses added yet.</p>
                    </div>
                    <div class="mt-4 p-4 bg-indigo-50 rounded-lg flex justify-between items-center">
                        <span class="text-lg font-bold text-indigo-800">Total Expenses:</span>
                        <span id="total-expenses" class="text-xl font-extrabold text-indigo-900">$0.00</span>
                    </div>
                </div>

                <div id="expense-message" class="message-box hidden"></div>
            </div>

            <div id="investment-section" class="expense-card hidden">
                <h2 class="text-2xl font-bold text-gray-800">My Investments</h2>

                <form id="add-investment-form" class="flex flex-col gap-3 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Add New Investment</h3>
                    <input type="text" id="investment-name" placeholder="Investment Name (e.g., Stock, Crypto)" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <input type="number" id="investment-amount" placeholder="Amount Invested" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" step="0.01" required>
                    <input type="date" id="investment-date" class="p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" required>
                    <button type="submit" class="p-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">Add Investment</button>
                </form>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Investment List</h3>
                    <div id="investments-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4" id="no-investments-message">No investments added yet.</p>
                    </div>
                    <div class="mt-4 p-4 bg-indigo-50 rounded-lg flex justify-between items-center">
                        <span class="text-lg font-bold text-indigo-800">Total Investments:</span>
                        <span id="total-investments" class="text-xl font-extrabold text-indigo-900">$0.00</span>
                    </div>
                </div>
                <div id="investment-message" class="message-box hidden"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            deleteDoc,
            doc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // --- Firebase Initialization ---
        let app;
        let db;
        let auth;
        let userId = null; // To store the current user's ID
        let isAuthReady = false; // Flag to indicate if auth state has been checked

        // User provided firebaseConfig directly, so use it.
        const firebaseConfig = {
            apiKey: "AIzaSyBmcBMtmd_DDPUiSRnzYiuspBC-GPKeAso",
            authDomain: "expensetracker-b0af0.firebaseapp.com",
            projectId: "expensetracker-b0af0",
            storageBucket: "expensetracker-b0af0.firebaseapp.com",
            messagingSenderId: "837224581675",
            appId: "1:837224581675:web:7cbb65f59b9622cc44386e"
        };

        // Get __app_id from Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            displayMessage("auth-message", "Error initializing app. Please try again later.", "error");
        }

        // --- DOM Elements ---
        const appWrapper = document.getElementById('app-wrapper');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const authSection = document.getElementById('auth-section');
        const expenseTrackerSection = document.getElementById('expense-tracker-section');
        const investmentSection = document.getElementById('investment-section');
        // const contactUsSection = document.getElementById('contact-us-section'); // REMOVED: Get the contact us section
        const showLoginBtn = document.getElementById('show-login');
        const showSignupBtn = document.getElementById('show-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const authMessageDiv = document.getElementById('auth-message');
        const logoutSidebarButton = document.getElementById('logout-sidebar-button');

        // Sidebar Navigation Buttons
        const profileSidebarBtn = document.getElementById('profile-sidebar-btn');
        const expensesSidebarBtn = document.getElementById('expenses-sidebar-btn'); 
        const investmentsSidebarBtn = document.getElementById('investments-sidebar-btn'); 
        const aboutSidebarBtn = document.getElementById('about-sidebar-btn');
        const messagesSidebarBtn = document.getElementById('messages-sidebar-btn');
        // const contactUsSidebarBtn = document.getElementById('contact-us-sidebar-btn'); // REMOVED

        // Expense Form Elements
        const addExpenseForm = document.getElementById('add-expense-form');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseCategorySelect = document.getElementById('expense-category');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseDateInput = document.getElementById('expense-date');
        const expensesListDiv = document.getElementById('expenses-list');
        const totalExpensesSpan = document.getElementById('total-expenses');
        const expenseMessageDiv = document.getElementById('expense-message');
        const noExpensesMessage = document.getElementById('no-expenses-message');

        // Investment Form Elements
        const addInvestmentForm = document.getElementById('add-investment-form');
        const investmentNameInput = document.getElementById('investment-name');
        const investmentAmountInput = document.getElementById('investment-amount');
        const investmentDateInput = document.getElementById('investment-date');
        const investmentsListDiv = document.getElementById('investments-list');
        const totalInvestmentsSpan = document.getElementById('total-investments');
        const investmentMessageDiv = document.getElementById('investment-message');
        const noInvestmentsMessage = document.getElementById('no-investments-message');


        // --- Helper Functions ---
        function displayMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `message-box ${type}`;
                element.classList.remove('hidden');
                setTimeout(() => {
                    element.classList.add('hidden');
                    element.textContent = '';
                }, 5000); // Hide after 5 seconds
            }
        }

        function toggleAuthForms(formToShow) {
            if (formToShow === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                showLoginBtn.classList.add('active');
                showSignupBtn.classList.remove('active');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                showSignupBtn.classList.add('active');
                showLoginBtn.classList.remove('active');
            }
            authMessageDiv.classList.add('hidden'); // Clear any previous auth messages
        }

        function setActiveSidebarItem(activeBtn) {
            const allSidebarItems = document.querySelectorAll('.sidebar-nav-item');
            allSidebarItems.forEach(item => {
                item.classList.remove('active-sidebar-item');
            });
            activeBtn.classList.add('active-sidebar-item');
        }


        function showSection(sectionToShow, activeSidebarBtn = null) {
            // Hide all main content sections
            authSection.classList.add('hidden');
            expenseTrackerSection.classList.add('hidden');
            investmentSection.classList.add('hidden');


            // Show the requested section
            sectionToShow.classList.remove('hidden');

            // Set active sidebar item if provided
            if (activeSidebarBtn) {
                setActiveSidebarItem(activeSidebarBtn);
            }
        }

        function renderExpenses(currentExpenses) {
            expensesListDiv.innerHTML = ''; // Clear previous list
            let total = 0;

            if (currentExpenses.length === 0) {
                noExpensesMessage.classList.remove('hidden');
                expensesListDiv.appendChild(noExpensesMessage);
            } else {
                noExpensesMessage.classList.add('hidden');
                // Sort expenses by timestamp in descending order (newest first)
                currentExpenses.sort((a, b) => b.timestamp - a.timestamp);

                currentExpenses.forEach(expense => {
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'flex justify-between items-center p-3 bg-white rounded-md shadow-sm border border-gray-200';
                    
                    // Format the date for display
                    const formattedDate = expense.date ? new Date(expense.date + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';

                    expenseItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${expense.description}</p>
                            <p class="text-sm text-gray-500">Category: ${expense.category || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Date: ${formattedDate}</p>
                            <p class="text-sm text-gray-500">Amount: $${expense.amount.toFixed(2)}</p>
                        </div>
                        <button data-id="${expense.id}" class="delete-expense-btn px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm font-medium hover:bg-red-200 transition duration-150 ease-in-out">Delete</button>
                    `;
                    expensesListDiv.appendChild(expenseItem);
                    total += expense.amount;
                });
            }
            totalExpensesSpan.textContent = `$${total.toFixed(2)}`;
        }


        function renderInvestments(currentInvestments) {
            investmentsListDiv.innerHTML = ''; // Clear previous list
            let total = 0;

            if (currentInvestments.length === 0) {
                noInvestmentsMessage.classList.remove('hidden');
                investmentsListDiv.appendChild(noInvestmentsMessage);
            } else {
                noInvestmentsMessage.classList.add('hidden');
                // Sort investments by timestamp in descending order (newest first)
                currentInvestments.sort((a, b) => b.timestamp - a.timestamp);

                currentInvestments.forEach(investment => {
                    const investmentItem = document.createElement('div');
                    investmentItem.className = 'flex justify-between items-center p-3 bg-white rounded-md shadow-sm border border-gray-200';
                    
                    // Format the date for display
                    const formattedDate = investment.date ? new Date(investment.date + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';

                    investmentItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${investment.name}</p>
                            <p class="text-sm text-gray-500">Date: ${formattedDate}</p>
                            <p class="text-sm text-gray-500">Amount: $${investment.amount.toFixed(2)}</p>
                        </div>
                        <button data-id="${investment.id}" class="delete-investment-btn px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm font-medium hover:bg-red-200 transition duration-150 ease-in-out">Delete</button>
                    `;
                    investmentsListDiv.appendChild(investmentItem);
                    total += investment.amount;
                });
            }
            totalInvestmentsSpan.textContent = `$${total.toFixed(2)}`;
        }


        // --- Event Listeners ---

        // Toggle between login and signup forms
        showLoginBtn.addEventListener('click', () => toggleAuthForms('login'));
        showSignupBtn.addEventListener('click', () => toggleAuthForms('signup'));

        // Handle User Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                displayMessage("auth-message", "Logged in successfully!", "success");
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Failed to log in. Please check your credentials.";
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password.';
                }
                displayMessage("auth-message", errorMessage, "error");
            }
        });

        // Handle User Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;

            if (password !== confirmPassword) {
                displayMessage("auth-message", "Passwords do not match.", "error");
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                displayMessage("auth-message", "Account created and logged in successfully!", "success");
            } catch (error) {
                console.error("Sign up error:", error);
                let errorMessage = "Failed to create account. Please try again.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email address already in use.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                }
                displayMessage("auth-message", errorMessage, "error");
            }
        });

        // Handle User Logout
        logoutSidebarButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                displayMessage("auth-message", "Logged out successfully!", "success");
            } catch (error) {
                console.error("Logout error:", error);
                displayMessage("auth-message", "Failed to log out. Please try again.", "error");
            }
        });

        // --- Sidebar Navigation Handlers ---
        // New sidebar button event listeners
        profileSidebarBtn.addEventListener('click', () => {
            displayMessage("expense-message", "Profile page coming soon!", "success");
            showSection(expenseTrackerSection, profileSidebarBtn);
        });

        expensesSidebarBtn.addEventListener('click', () => {
            showSection(expenseTrackerSection, expensesSidebarBtn);
        });

        investmentsSidebarBtn.addEventListener('click', () => {
            showSection(investmentSection, investmentsSidebarBtn);
        });

        aboutSidebarBtn.addEventListener('click', () => {
            displayMessage("expense-message", "About page coming soon!", "success");
            showSection(expenseTrackerSection, aboutSidebarBtn);
        });

        messagesSidebarBtn.addEventListener('click', () => {
            displayMessage("expense-message", "Messages page coming soon!", "success");
            showSection(expenseTrackerSection, messagesSidebarBtn);
        });


        // Handle Adding New Expense
        addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = expenseDescriptionInput.value.trim();
            const category = expenseCategorySelect.value;
            const amount = parseFloat(expenseAmountInput.value);
            const date = expenseDateInput.value;

            if (!description || !category || isNaN(amount) || amount <= 0 || !date) {
                displayMessage("expense-message", "Please fill in all fields: description, category, amount, and date.", "error");
                return;
            }

            if (!userId) {
                displayMessage("expense-message", "User not authenticated. Please log in.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), {
                    description: description,
                    category: category,
                    amount: amount,
                    date: date,
                    timestamp: serverTimestamp()
                });
                displayMessage("expense-message", "Expense added successfully!", "success");
                expenseDescriptionInput.value = '';
                expenseCategorySelect.value = '';
                expenseAmountInput.value = '';
                expenseDateInput.value = '';
            } catch (error) {
                console.error("Error adding expense:", error);
                displayMessage("expense-message", "Failed to add expense. Please try again.", "error");
            }
        });

        // Handle Deleting Expense (Event delegation)
        expensesListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-expense-btn')) {
                const expenseId = e.target.dataset.id;
                if (!expenseId) {
                    console.error("No expense ID found for deletion.");
                    return;
                }

                if (!userId) {
                    displayMessage("expense-message", "User not authenticated. Cannot delete expense.", "error");
                    return;
                }

                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses`, expenseId));
                    displayMessage("expense-message", "Expense deleted successfully!", "success");
                } catch (error) {
                    console.error("Error deleting expense:", error);
                    displayMessage("expense-message", "Failed to delete expense. Please try again.", "error");
                }
            }
        });

        // Handle Adding New Investment
        addInvestmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = investmentNameInput.value.trim();
            const amount = parseFloat(investmentAmountInput.value);
            const date = investmentDateInput.value;

            if (!name || isNaN(amount) || amount <= 0 || !date) {
                displayMessage("investment-message", "Please fill in all fields: name, amount, and date.", "error");
                return;
            }

            if (!userId) {
                displayMessage("investment-message", "User not authenticated. Please log in.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/investments`), {
                    name: name,
                    amount: amount,
                    date: date,
                    timestamp: serverTimestamp()
                });
                displayMessage("investment-message", "Investment added successfully!", "success");
                investmentNameInput.value = '';
                investmentAmountInput.value = '';
                investmentDateInput.value = '';
            } catch (error) {
                console.error("Error adding investment:", error);
                displayMessage("investment-message", "Failed to add investment. Please try again.", "error");
            }
        });

        // Handle Deleting Investment (Event delegation)
        investmentsListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-investment-btn')) {
                const investmentId = e.target.dataset.id;
                if (!investmentId) {
                    console.error("No investment ID found for deletion.");
                    return;
                }

                if (!userId) {
                    displayMessage("investment-message", "User not authenticated. Cannot delete investment.", "error");
                    return;
                }

                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/investments`, investmentId));
                    displayMessage("investment-message", "Investment deleted successfully!", "success");
                } catch (error) {
                    console.error("Error deleting investment:", error);
                    displayMessage("investment-message", "Failed to delete investment. Please try again.", "error");
                }
            }
        });


        // --- Firebase Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            isAuthReady = true;
            if (user) {
                // User is signed in.
                userId = user.uid;
                sidebar.classList.add('visible');
              
                showSection(expenseTrackerSection, expensesSidebarBtn); 

                console.log("User logged in:", userId);

                // Setup real-time listener for expenses
                const expensesQuery = query(collection(db, `artifacts/${appId}/users/${userId}/expenses`));
                onSnapshot(expensesQuery, (snapshot) => {
                    const expensesData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        expensesData.push({
                            id: doc.id,
                            description: data.description,
                            category: data.category,
                            amount: data.amount,
                            date: data.date,
                            timestamp: data.timestamp ? data.timestamp.toMillis() : 0
                        });
                    });
                    renderExpenses(expensesData);
                }, (error) => {
                    console.error("Error fetching expenses:", error);
                    displayMessage("expense-message", "Failed to load expenses. Please try again.", "error");
                });

                // Setup real-time listener for investments
                const investmentsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/investments`));
                onSnapshot(investmentsQuery, (snapshot) => {
                    const investmentsData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        investmentsData.push({
                            id: doc.id,
                            name: data.name,
                            amount: data.amount,
                            date: data.date,
                            timestamp: data.timestamp ? data.timestamp.toMillis() : 0
                        });
                    });
                    renderInvestments(investmentsData);
                }, (error) => {
                    console.error("Error fetching investments:", error);
                    displayMessage("investment-message", "Failed to load investments. Please try again.", "error");
                });

            } else {
                // User is signed out.
                userId = null;
                sidebar.classList.remove('visible');
                showSection(authSection); 
                toggleAuthForms('login'); 
                console.log("User logged out.");
            }
        });

        // --- Initial Setup ---
        window.onload = async function () {
            if (auth) {
                console.log("App loaded. Waiting for Firebase Auth state.");
            } else {
                console.error("Auth object not initialized. Cannot proceed with authentication.");
                displayMessage("auth-message", "Firebase Auth not initialized. Please check console for errors.", "error");
            }

        };
    </script>
</body>
</html>